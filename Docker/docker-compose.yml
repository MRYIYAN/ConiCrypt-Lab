version: "3.9"

#================================================================#
# DOCKER COMPOSE para CONiCRYPT - Laboratório de Criptografia
#================================================================#

#--------------------------------#
# Redes internas
#--------------------------------#
networks:
  conicrypt_net:
    driver: bridge

#--------------------------------#
# Servicios 
#--------------------------------#
services:

  #==============================#
  # Núcleo matemático en C
  #==============================#
  core:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.core
    container_name: conicrypt_core
    networks:
      - conicrypt_net
    volumes:
      - ../Core:/app/Core
      - ../Data:/app/Data
      - ../Output:/app/Output
    extra_hosts:
      - host.docker.internal:host-gateway
    tty: true
    command: >
      bash -c 'last_build=0;
      while true; do
        new_time=$$(find /app/Core/src -type f -printf "%T@\n" | sort -n | tail -1);
        if [ "$$new_time" != "$$last_build" ]; then
          echo "[CORE] Cambios detectados, recompilando...";
          make -C /app/Core && last_build=$$new_time;
        fi;
        sleep 2;
      done'

  #==============================#
  # Módulo de visualización Python
  #==============================#
  plotter:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.python
    container_name: conicrypt_plotter
    env_file:
      - .env
    networks:
      - conicrypt_net
    ports:
      - "5001:5000"
    volumes:
      - ../Python:/app/Python
      - ../Core:/app/Core
      - ../Data:/app/Data
      - ../Output:/app/Output
    depends_on:
      - core
    tty: true

  #==============================#
  # Interfaz de escritorio React + Tauri
  #==============================#
  app:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.frontend
    container_name: conicrypt_app
    env_file:
      - .env
    networks:
      - conicrypt_net
    ports:
      - "1421:1420"  # solo puerto del front 
    volumes:
      - ../App:/app/App
      - ../Data:/app/Data
      - ../Output:/app/Output
      - ./startup_app.sh:/usr/local/bin/startup_app.sh
      - cargo-registry:/root/.cargo/registry
      - cargo-git:/root/.cargo/git
      - tauri-target:/app/App/src-tauri/target
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      - core
      - plotter
    tty: true
    stdin_open: true
    command: >
      bash -c '
      echo "====================================================";
      echo "   Iniciando CONiCRYPT-LAB (React + Tauri + WS)";
      echo "====================================================";
      chmod +x /usr/local/bin/startup_app.sh;
      /usr/local/bin/startup_app.sh'

volumes:
  cargo-registry:
  cargo-git:
  tauri-target:
