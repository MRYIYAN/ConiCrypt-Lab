version: "3.9"

#================================================================#
# DOCKER COMPOSE para CONiCRYPT - Laboratório de Criptografia
#================================================================#

#--------------------------------#
# Redes internas
#--------------------------------#
networks:
  conicrypt_net:
    driver: bridge

#--------------------------------#
# Servicios 
#--------------------------------#
services:

  #==============================#
  # Núcleo matemático en C
  #==============================#
  core:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.core
    container_name: conicrypt_core
    networks:
      - conicrypt_net
    ports:
      - "5000:5000"     #  expone puerto 5000 al host
    volumes:
      - ../Core:/app/Core
      - ../Data:/app/Data
      - ../Output:/app/Output
    extra_hosts:
      - host.docker.internal:host-gateway
    tty: true
    command: >
      bash -c 'last_build=0;
      while true; do
        new_time=$$(find /app/Core/src -type f -printf "%T@\n" | sort -n | tail -1);
        if [ "$$new_time" != "$$last_build" ]; then
          echo "[CORE] Cambios detectados, recompilando...";
          make -C /app/Core && last_build=$$new_time;
        fi;
        sleep 2;
      done'

  #==============================#
  # Módulo de visualización Python
  #==============================#
  plotter:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.python
    container_name: conicrypt_plotter
    networks:
      - conicrypt_net
    ports:
      - "5001:5001"     #  expone puerto 5001 al host
    volumes:
      - ../Python:/app/Python
      - ../Data:/app/Data
      - ../Output:/app/Output
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      - core
    tty: true
    command: ["bash", "-c", "while inotifywait -e modify /app/Data/conic.json; do python3 /app/Python/plot_conics.py; done"]

  #==============================#
  # Interfaz de escritorio React + Tauri
  #==============================#
  app:
    build:
      context: ..
      dockerfile: Docker/Dockerfile.frontend
    container_name: conicrypt_app
    networks:
      - conicrypt_net
    ports:
      - "1421:1420"  # solo puerto del front si lo usas
    environment:
      - WS_HOST=host.docker.internal
      - WS_PORT=9191
      - CORE_URL=http://host.docker.internal:5000   #  para Tauri/React
      - PLOTTER_URL=http://host.docker.internal:5001
    volumes:
      - ../App:/app/App
      - ../Data:/app/Data
      - ../Output:/app/Output
      - ./startup_app.sh:/usr/local/bin/startup_app.sh
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      - core
      - plotter
    tty: true
    stdin_open: true
    command: >
      bash -c '
      echo "====================================================";
      echo "   Iniciando CONiCRYPT-LAB (React + Tauri + WS)";
      echo "====================================================";
      chmod +x /usr/local/bin/startup_app.sh;
      /usr/local/bin/startup_app.sh'
